<?php

header("Content-type: text/html; charset=utf-8");
$con = mysql_connect("192.168.64.73","mt4","1qaz2wsx");

if (!$con)
  {
  die('Could not connect: ' . mysql_error());
  }

mysql_select_db("live1", $con);


$sql="SELECT SYMBOL, SUM(NET_VOL) AS NET_VOL,SUM(PIP_VALUE) AS PIP_VALUE,SUM(SUM_REVENUE) AS SUM_REVENUE,SUM(SUM_VOL) AS SUM_VOL,MAX(AVG_PRICE) AS AVG_PRICE,MAX(BID_ASK) AS BID_ASK,TIME(NOW()) AS `TIME`,SUM(Daily_REVENUE) AS Daily_REVENUE,SUM(Daily_VOL) AS Daily_VOL,SUM(Two_PROFIT)-SUM(Daily_REVENUE) AS Yest_REVENUE,SUM(Two_VOL)-SUM(Daily_VOL) AS Yest_VOL FROM 
(
(
SELECT B.SYMBOL AS SYMBOL,SUM(B.VOL)*(-1) AS NET_VOL,
ROUND(ABS((CASE WHEN CONVT_SYMBOL LIKE 'USD%' THEN ROUND(POW(0.1,mt4_symbols_update.DIGITS)*mt4_symbols_update.CONTRACT_SIZE*10,0)/COALESCE(mt4_prices.BID,1)
 WHEN CONVT_SYMBOL LIKE '%USD' THEN ROUND(POW(0.1,mt4_symbols_update.DIGITS)*mt4_symbols_update.CONTRACT_SIZE*10,0)*COALESCE(mt4_prices.BID,1) ELSE 0 END)*SUM(B.VOL)),5) AS PIP_VALUE,
SUM(B.PROFIT)*(-1) AS SUM_REVENUE,SUM(B.SUMVOL) AS SUM_VOL,ROUND(CASE WHEN SUM(B.VOL) > 0 THEN SUM(B.SUM_BUY)/SUM(B.VOL_BUY) WHEN SUM(B.VOL) < 0 THEN SUM(B.SUM_SELL)/SUM(B.VOL_SELL) ELSE 0 END,5) AS AVG_PRICE,
CONCAT(B.BID,'/',B.ASK) AS `BID_ASK`,SUM(B.Daily_PROFIT)*(-1) AS Daily_REVENUE,SUM(B.Daily_VOL) AS Daily_VOL,SUM(Two_VOL) AS Two_VOL,SUM(Two_PROFIT)*(-1) AS Two_PROFIT FROM(
(SELECT 'live1' AS LIVE,(CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END) AS `SYMBOL`,
CASE WHEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') IN (SELECT SYMBOL FROM live1.mt4_prices) THEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') WHEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) IN (SELECT SYMBOL FROM live1.mt4_prices) THEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) ELSE 'USD' END AS CONVT_SYMBOL,
ROUND(MAX(mt4_prices.BID),5) AS BID,ROUND(MIN(mt4_prices.ASK),5) AS ASK,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*(-0.01) ELSE 0 END) AS VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS SUMVOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Daily_VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Two_VOL,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Daily_PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live1.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Two_PROFIT
FROM live1.mt4_trades,live1.mt4_users,live1.mt4_prices WHERE mt4_trades.LOGIN = mt4_users.LOGIN AND mt4_trades.`GROUP` NOT LIKE '0%' AND CONCAT(LEFT((CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END),6),'q') = mt4_prices.SYMBOL AND (mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' 
OR mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))
AND LENGTH(mt4_trades.SYMBOL)>0 AND mt4_trades.CMD <2 AND mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND LIVE = 'live1') GROUP BY (CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END))
UNION
(SELECT 'live2' AS LIVE,(CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END) AS `SYMBOL`,
CASE WHEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') IN (SELECT SYMBOL FROM live2.mt4_prices) THEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD')
WHEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) IN (SELECT SYMBOL FROM live2.mt4_prices) THEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) ELSE 'USD' END AS CONVT_SYMBOL,
ROUND(MAX(mt4_prices.BID),5) AS BID,ROUND(MIN(mt4_prices.ASK),5) AS ASK,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*(-0.01) ELSE 0 END) AS VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS SUMVOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Daily_VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Two_VOL,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Daily_PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Two_PROFIT
FROM live2.mt4_trades,live2.mt4_users,live2.mt4_prices WHERE mt4_trades.LOGIN = mt4_users.LOGIN AND mt4_trades.`GROUP` NOT LIKE '0%' AND CONCAT(LEFT((CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END),6),'q') = mt4_prices.SYMBOL AND (mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' 
OR mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY)) 
AND LENGTH(mt4_trades.SYMBOL)>0 AND mt4_trades.CMD <2 AND mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND LIVE = 'live2') GROUP BY (CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END))
UNION
(SELECT 'live3' AS LIVE,(CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END) AS `SYMBOL`,
CASE WHEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') IN (SELECT SYMBOL FROM live3.mt4_prices) THEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD')
WHEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) IN (SELECT SYMBOL FROM live3.mt4_prices) THEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) ELSE 'USD' END AS CONVT_SYMBOL,
ROUND(MAX(mt4_prices.BID),5) AS BID,ROUND(MIN(mt4_prices.ASK),5) AS ASK,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*(-0.01) ELSE 0 END) AS VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS SUMVOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Daily_VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Two_VOL,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > (CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Daily_PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live3.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Two_PROFIT
FROM live3.mt4_trades,live3.mt4_users,live3.mt4_prices WHERE mt4_trades.LOGIN = mt4_users.LOGIN AND mt4_trades.`GROUP` NOT LIKE '0%' AND CONCAT(LEFT((CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END),6),'q') = mt4_prices.SYMBOL AND (mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' 
OR mt4_trades.CLOSE_TIME > DATE_SUB((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 DAY))  
AND LENGTH(mt4_trades.SYMBOL)>0 AND mt4_trades.CMD <2 AND mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND LIVE = 'live3') GROUP BY (CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END))
) AS B LEFT JOIN 
(SELECT * FROM live1.mt4_prices UNION SELECT * FROM live2.mt4_prices) AS mt4_prices
 ON B.CONVT_SYMBOL = mt4_prices.SYMBOL LEFT JOIN (SELECT * FROM live1.mt4_symbols_update UNION SELECT * FROM live2.mt4_symbols_update) AS mt4_symbols_update ON CONCAT(B.SYMBOL,'q') = mt4_symbols_update.SYMBOL GROUP BY B.SYMBOL
)

UNION
(
SELECT B.SYMBOL AS SYMBOL,SUM(B.VOL)*(-1) AS NET_VOL,
ROUND(ABS((CASE WHEN CONVT_SYMBOL LIKE 'USD%' THEN ROUND(POW(0.1,mt4_symbols_update.DIGITS)*mt4_symbols_update.CONTRACT_SIZE*10,0)/COALESCE(mt4_prices.BID,1)
 WHEN CONVT_SYMBOL LIKE '%USD' THEN ROUND(POW(0.1,mt4_symbols_update.DIGITS)*mt4_symbols_update.CONTRACT_SIZE*10,0)*COALESCE(mt4_prices.BID,1) ELSE 0 END)*SUM(B.VOL)),5) AS PIP_VALUE,
SUM(B.PROFIT)*(-1) AS SUM_REVENUE,SUM(B.SUMVOL) AS SUM_VOL,ROUND(CASE WHEN SUM(B.VOL) > 0 THEN SUM(B.SUM_BUY)/SUM(B.VOL_BUY) WHEN SUM(B.VOL) < 0 THEN SUM(B.SUM_SELL)/SUM(B.VOL_SELL) ELSE 0 END,5) AS AVG_PRICE,
CONCAT(B.BID,'/',B.ASK) AS `BID_ASK`,SUM(B.Daily_PROFIT)*(-1) AS Daily_REVENUE,SUM(B.Daily_VOL) AS Daily_VOL,SUM(Two_VOL) AS Two_VOL,SUM(Two_PROFIT)*(-1) AS Two_PROFIT FROM(
(SELECT 'live5' AS LIVE,(CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END) AS `SYMBOL`,
CASE WHEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') IN (SELECT SYMBOL FROM live5.mt4_prices) THEN CONCAT(MID(mt4_trades.SYMBOL,4,3),'USD') WHEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) IN (SELECT SYMBOL FROM live5.mt4_prices) THEN CONCAT('USD',MID(mt4_trades.SYMBOL,4,3)) ELSE 'USD' END AS CONVT_SYMBOL,
ROUND(MAX(mt4_prices.BID),5) AS BID,ROUND(MIN(mt4_prices.ASK),5) AS ASK,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 ELSE 0 END) AS VOL_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_BUY,
SUM(CASE WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.OPEN_PRICE*mt4_trades.VOLUME*0.01 ELSE 0 END) AS SUM_SELL,
SUM(CASE WHEN (mt4_trades.CMD = 0 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*0.01 WHEN (mt4_trades.CMD = 1 AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.VOLUME*(-0.01) ELSE 0 END) AS VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS SUMVOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Daily_VOL,
SUM(CASE WHEN mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY) THEN mt4_trades.VOLUME ELSE 0 END)*0.01 AS Two_VOL,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00') THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Daily_PROFIT,
ROUND(SUM(CASE 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'USD') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN mt4_trades.PROFIT+mt4_trades.SWAPS 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'EUR') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'EURUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'GBP') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'GBPUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'NZD') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'NZDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'AUD') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)*(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'AUDUSD' ORDER BY TIME DESC LIMIT 1) 
WHEN (mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND CURRENCY = 'SGD') AND (mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY))) THEN (mt4_trades.PROFIT+mt4_trades.SWAPS)/(SELECT AVERAGE FROM live5.daily_prices WHERE SYMBOL LIKE 'USDSGD' ORDER BY TIME DESC LIMIT 1) ELSE 0 END),2) AS Two_PROFIT
FROM live5.mt4_trades,live5.mt4_users,(SELECT (CASE WHEN mt4_prices.SYMBOL LIKE BINARY '%q' THEN mt4_prices.SYMBOL ELSE CONCAT(mt4_prices.SYMBOL,'q') END) AS SYM,mt4_prices.BID,mt4_prices.ASK FROM live5.mt4_prices GROUP BY SYM) AS mt4_prices
WHERE mt4_trades.LOGIN = mt4_users.LOGIN AND mt4_trades.`GROUP` NOT LIKE '0%' AND CONCAT(LEFT((CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END),6),'q') = mt4_prices.SYM AND (mt4_trades.CLOSE_TIME = '1970-01-01 00:00:00' 
OR mt4_trades.CLOSE_TIME > DATE_SUB(DATE_ADD((CASE WHEN HOUR(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR)) < 23 THEN DATE_FORMAT(DATE_SUB(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),INTERVAL 1 DAY),'%Y-%m-%d 23:00:00') ELSE DATE_FORMAT(DATE_SUB(NOW(),INTERVAL (SELECT SERVER_TIME_DIFF FROM live5.live1_time_diff) HOUR),'%Y-%m-%d 23:00:00') END),INTERVAL 1 HOUR),INTERVAL 1 DAY)) 
AND LENGTH(mt4_trades.SYMBOL)>0 AND mt4_trades.CMD <2 AND mt4_trades.`GROUP` IN (SELECT `GROUP` FROM live5.group_table WHERE BOOK = 'B' AND LIVE = 'live5') GROUP BY (CASE WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%y' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'y',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%q' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'q',1) 
WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%`' THEN SUBSTRING_INDEX(SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2),'`',1) WHEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) LIKE '.%' THEN SUBSTRING_INDEX(mt4_trades.SYMBOL,'.',2) ELSE LEFT(mt4_trades.SYMBOL,6) END))
) AS B LEFT JOIN live5.mt4_prices ON B.CONVT_SYMBOL = mt4_prices.SYMBOL 
LEFT JOIN (SELECT (CASE WHEN mt4_symbols_update.SYMBOL LIKE BINARY '%q' THEN mt4_symbols_update.SYMBOL ELSE CONCAT(mt4_symbols_update.SYMBOL,'q') END) AS SYM,mt4_symbols_update.DIGITS,MAX(mt4_symbols_update.CONTRACT_SIZE) AS CONTRACT_SIZE FROM live5.mt4_symbols_update GROUP BY SYM) AS mt4_symbols_update 
ON CONCAT(B.SYMBOL,'q') = mt4_symbols_update.SYM GROUP BY B.SYMBOL
)
) AS X GROUP BY SYMBOL ORDER BY ABS(SUM(NET_VOL)) DESC,ABS(SUM(SUM_REVENUE)) DESC;";

  $result = mysql_query($sql,$con) or die(mysql_error());
 
while ( $v=mysql_fetch_assoc($result)) {

    $arr[] = $v;

}
    echo json_encode($arr);  

?>



